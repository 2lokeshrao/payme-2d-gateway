<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activation Codes - Admin Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #667eea;
            font-size: 28px;
            margin-bottom: 5px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        .nav {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .nav a {
            padding: 10px 20px;
            background: #f0f0f0;
            color: #333;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .nav a:hover, .nav a.active {
            background: #667eea;
            color: white;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .card h2 {
            color: #333;
            font-size: 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table th,
        table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        table th {
            background: #f9fafb;
            color: #333;
            font-weight: 600;
        }

        table tr:hover {
            background: #f9fafb;
        }

        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-unused {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-used {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-expired {
            background: #fee2e2;
            color: #991b1b;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-card h3 {
            color: #667eea;
            font-size: 32px;
            margin-bottom: 5px;
        }

        .stat-card p {
            color: #666;
            font-size: 14px;
        }

        .code-display {
            background: #1e293b;
            color: #10b981;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 24px;
            text-align: center;
            margin: 20px 0;
            letter-spacing: 2px;
            position: relative;
        }

        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .copy-btn:hover {
            background: #5568d3;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border-left: 4px solid #3b82f6;
        }

        .filter-section {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-section select,
        .filter-section input {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
    </style>
    <link rel="stylesheet" href="responsive-admin.css?v=5.0">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîë Activation Codes Management</h1>
            <p>Generate, manage, and track activation codes</p>
        </div>

        <div class="nav">
            <a href="dashboard.html">üìä Dashboard</a>
            <a href="plan-management.html">üíé Plans</a>
            <a href="reseller-management.html">üë• Resellers</a>
            <a href="activation-codes.html" class="active">üîë Activation Codes</a>
            <a href="settings.html">‚öôÔ∏è Settings</a>
            <a href="../index.html">üö™ Logout</a>
        </div>

        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3 id="totalCodes">0</h3>
                <p>Total Codes</p>
            </div>
            <div class="stat-card">
                <h3 id="unusedCodes">0</h3>
                <p>Unused Codes</p>
            </div>
            <div class="stat-card">
                <h3 id="usedCodes">0</h3>
                <p>Used Codes</p>
            </div>
            <div class="stat-card">
                <h3 id="expiredCodes">0</h3>
                <p>Expired Codes</p>
            </div>
        </div>

        <div class="grid-2">
            <!-- Generate Single Code -->
            <div class="card">
                <h2>‚ûï Generate Single Code</h2>
                <form id="generateSingleForm">
                    <div class="form-group">
                        <label>Select Plan *</label>
                        <select id="singlePlan" required>
                            <option value="">Choose Plan</option>
                            <option value="1">Monthly Plan - $60</option>
                            <option value="2">Quarterly Plan - $150</option>
                            <option value="3">Yearly Plan - $500</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Valid For (Days) *</label>
                        <input type="number" id="singleValidity" placeholder="365" value="365" required>
                    </div>

                    <div class="form-group">
                        <label>Assign to Reseller (Optional)</label>
                        <select id="singleReseller">
                            <option value="">Admin (Self)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Notes (Optional)</label>
                        <input type="text" id="singleNotes" placeholder="For customer XYZ">
                    </div>

                    <button type="submit" class="btn btn-primary">Generate Code</button>
                </form>

                <div id="generatedCodeDisplay" style="display: none;">
                    <div class="code-display">
                        <button class="copy-btn" onclick="copyCode()">Copy</button>
                        <div id="generatedCode"></div>
                    </div>
                    <div class="alert alert-success">
                        ‚úÖ Activation code generated successfully! Share this code with your customer.
                    </div>
                </div>
            </div>

            <!-- Generate Bulk Codes -->
            <div class="card">
                <h2>üì¶ Generate Bulk Codes</h2>
                <form id="generateBulkForm">
                    <div class="form-group">
                        <label>Select Plan *</label>
                        <select id="bulkPlan" required>
                            <option value="">Choose Plan</option>
                            <option value="1">Monthly Plan - $60</option>
                            <option value="2">Quarterly Plan - $150</option>
                            <option value="3">Yearly Plan - $500</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Number of Codes *</label>
                        <input type="number" id="bulkQuantity" placeholder="10" min="1" max="100" required>
                    </div>

                    <div class="form-group">
                        <label>Valid For (Days) *</label>
                        <input type="number" id="bulkValidity" placeholder="365" value="365" required>
                    </div>

                    <div class="form-group">
                        <label>Assign to Reseller (Optional)</label>
                        <select id="bulkReseller">
                            <option value="">Admin (Self)</option>
                        </select>
                    </div>

                    <button type="submit" class="btn btn-primary">Generate Bulk Codes</button>
                </form>

                <div id="bulkCodesDisplay" style="display: none; margin-top: 20px;">
                    <div class="alert alert-success">
                        ‚úÖ <span id="bulkCount"></span> codes generated successfully!
                    </div>
                    <button class="btn btn-success" onclick="downloadBulkCodes()">üì• Download CSV</button>
                    <button class="btn btn-primary" onclick="copyBulkCodes()">üìã Copy All</button>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="card">
            <h2>üîç Filter Codes</h2>
            <div class="filter-section">
                <select id="filterStatus" onchange="filterCodes()">
                    <option value="">All Status</option>
                    <option value="unused">Unused</option>
                    <option value="used">Used</option>
                    <option value="expired">Expired</option>
                </select>

                <select id="filterPlan" onchange="filterCodes()">
                    <option value="">All Plans</option>
                    <option value="1">Monthly Plan</option>
                    <option value="2">Quarterly Plan</option>
                    <option value="3">Yearly Plan</option>
                </select>

                <select id="filterReseller" onchange="filterCodes()">
                    <option value="">All Resellers</option>
                    <option value="admin">Admin</option>
                </select>

                <input type="text" id="searchCode" placeholder="Search by code..." onkeyup="filterCodes()">
            </div>
        </div>

        <!-- Codes List -->
        <div class="card">
            <h2>üìã All Activation Codes</h2>
            <table>
                <thead>
                    <tr>
                        <th>Code</th>
                        <th>Plan</th>
                        <th>Status</th>
                        <th>Created By</th>
                        <th>Created Date</th>
                        <th>Used By</th>
                        <th>Used Date</th>
                        <th>Expires</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="codesTableBody">
                    <tr>
                        <td colspan="9" style="text-align: center; color: #999;">No activation codes yet. Generate your first code above.</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let allCodes = [];
        let bulkGeneratedCodes = [];

        document.addEventListener('DOMContentLoaded', function() {
            loadCodes();
            loadStats();
            loadResellers();
        });

        // Generate Single Code
        document.getElementById('generateSingleForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const codeData = {
                plan_id: document.getElementById('singlePlan').value,
                validity_days: document.getElementById('singleValidity').value,
                reseller_id: document.getElementById('singleReseller').value || null,
                notes: document.getElementById('singleNotes').value
            };

            fetch('/api/admin/activation-codes.php?action=generate', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(codeData)
            })
            .then(response => response.json())
            .then(data => {
                if(data.success) {
                    document.getElementById('generatedCode').textContent = data.code;
                    document.getElementById('generatedCodeDisplay').style.display = 'block';
                    loadCodes();
                    loadStats();
                } else {
                    alert('Error: ' + data.message);
                }
            });
        });

        // Generate Bulk Codes
        document.getElementById('generateBulkForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const bulkData = {
                plan_id: document.getElementById('bulkPlan').value,
                quantity: document.getElementById('bulkQuantity').value,
                validity_days: document.getElementById('bulkValidity').value,
                reseller_id: document.getElementById('bulkReseller').value || null
            };

            fetch('/api/admin/activation-codes.php?action=generate-bulk', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(bulkData)
            })
            .then(response => response.json())
            .then(data => {
                if(data.success) {
                    bulkGeneratedCodes = data.codes;
                    document.getElementById('bulkCount').textContent = data.codes.length;
                    document.getElementById('bulkCodesDisplay').style.display = 'block';
                    loadCodes();
                    loadStats();
                } else {
                    alert('Error: ' + data.message);
                }
            });
        });

        function loadCodes() {
            fetch('/api/admin/activation-codes.php?action=list')
            .then(response => response.json())
            .then(data => {
                if(data.success) {
                    allCodes = data.codes;
                    updateCodesTable(data.codes);
                }
            });
        }

        function updateCodesTable(codes) {
            const tbody = document.getElementById('codesTableBody');
            if(codes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #999;">No codes found.</td></tr>';
                return;
            }

            tbody.innerHTML = codes.map(code => `
                <tr>
                    <td><strong>${code.code}</strong></td>
                    <td>${code.plan_name}</td>
                    <td><span class="badge badge-${code.status}">${code.status}</span></td>
                    <td>${code.created_by}</td>
                    <td>${formatDate(code.created_at)}</td>
                    <td>${code.used_by || '-'}</td>
                    <td>${code.used_at ? formatDate(code.used_at) : '-'}</td>
                    <td>${formatDate(code.expires_at)}</td>
                    <td>
                        ${code.status === 'unused' ? 
                            `<button class="btn btn-danger" style="padding: 5px 15px; font-size: 12px;" onclick="deleteCode('${code.code}')">Delete</button>` : 
                            '-'}
                    </td>
                </tr>
            `).join('');
        }

        function loadStats() {
            fetch('/api/admin/activation-codes.php?action=stats')
            .then(response => response.json())
            .then(data => {
                if(data.success) {
                    document.getElementById('totalCodes').textContent = data.stats.total;
                    document.getElementById('unusedCodes').textContent = data.stats.unused;
                    document.getElementById('usedCodes').textContent = data.stats.used;
                    document.getElementById('expiredCodes').textContent = data.stats.expired;
                }
            });
        }

        function loadResellers() {
            fetch('/api/admin/resellers.php?action=list')
            .then(response => response.json())
            .then(data => {
                if(data.success && data.resellers.length > 0) {
                    const options = data.resellers.map(r => 
                        `<option value="${r.id}">${r.name}</option>`
                    ).join('');
                    
                    document.getElementById('singleReseller').innerHTML += options;
                    document.getElementById('bulkReseller').innerHTML += options;
                    document.getElementById('filterReseller').innerHTML += options;
                }
            });
        }

        function filterCodes() {
            const status = document.getElementById('filterStatus').value;
            const plan = document.getElementById('filterPlan').value;
            const reseller = document.getElementById('filterReseller').value;
            const search = document.getElementById('searchCode').value.toLowerCase();

            let filtered = allCodes.filter(code => {
                if(status && code.status !== status) return false;
                if(plan && code.plan_id != plan) return false;
                if(reseller && code.reseller_id != reseller) return false;
                if(search && !code.code.toLowerCase().includes(search)) return false;
                return true;
            });

            updateCodesTable(filtered);
        }

        function deleteCode(code) {
            if(confirm('Are you sure you want to delete this activation code?')) {
                fetch(`/api/admin/activation-codes.php?action=delete&code=${code}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if(data.success) {
                        alert('Code deleted successfully!');
                        loadCodes();
                        loadStats();
                    } else {
                        alert('Error: ' + data.message);
                    }
                });
            }
        }

        function copyCode() {
            const code = document.getElementById('generatedCode').textContent;
            navigator.clipboard.writeText(code).then(() => {
                alert('Code copied to clipboard!');
            });
        }

        function copyBulkCodes() {
            const codes = bulkGeneratedCodes.join('\n');
            navigator.clipboard.writeText(codes).then(() => {
                alert('All codes copied to clipboard!');
            });
        }

        function downloadBulkCodes() {
            const csv = 'Activation Code,Plan,Expires At\n' + 
                bulkGeneratedCodes.map(code => `${code},Plan Name,Date`).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'activation-codes-' + Date.now() + '.csv';
            a.click();
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }
    </script>
    <script src="responsive-menu.js"></script>
    <script src="load-navbar.js"></script>
</body>
</html>
